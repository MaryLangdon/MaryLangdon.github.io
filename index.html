import React, { useState, useMemo, useEffect, useCallback } from 'react';
// 导入所有需要的图标
import { 
    Sun, Cloud, Zap, Droplet, Wind, Gauge, Sunrise, Sunset, Clock, MapPin, 
    Moon, X, ChevronDown, ChevronUp, Loader 
} from 'lucide-react';

// --- 配置 (Configuration) ---

// ** ⚠️ 重要的：请在此处填入您的 OpenWeatherMap API Key **
// 如果留空，应用将使用高保真模拟数据。
const OPEN_WEATHER_API_KEY = ""; 
const API_BASE_URL = "https://api.openweathermap.org/data/2.5/weather";

// 简化后的主题配置
const WEATHER_THEMES = {
    'clear': {
        'primary-container': 'bg-amber-100', 'on-primary-container': 'text-amber-900', 'icon-color': 'text-amber-500', 'progress-color': 'text-amber-600',
        'dark-primary-container': 'dark:bg-amber-800', 'dark-on-primary-container': 'dark:text-amber-100', 'dark-icon-color': 'dark:text-amber-300', 'dark-progress-color': 'dark:text-amber-400',
    },
    'cloudy': {
        'primary-container': 'bg-slate-200', 'on-primary-container': 'text-slate-900', 'icon-color': 'text-slate-600', 'progress-color': 'text-slate-600',
        'dark-primary-container': 'dark:bg-slate-700', 'dark-on-primary-container': 'dark:text-slate-100', 'dark-icon-color': 'dark:text-slate-400', 'dark-progress-color': 'dark:text-slate-400',
    }
};

const ROXY_QUOTES = {
    'clear': { day: "天气晴朗，正是远行的好日子！希望这段旅程充满惊喜。", night: "月色真美。即使在深夜，也要保持对冒险的渴望。" },
    'cloudy': { day: "多云的天气最适合思考魔法和策略了。专注，然后向前。", night: "云层遮住了星光，但不要紧，我心中的魔力之光永不熄灭。" },
};

// 中国和日本城市行政区划数据
const CITIES_DATA = {
    "直辖市 (Municipalities)": [ "北京 (Beijing)", "上海 (Shanghai)", "天津 (Tianjin)", "重庆 (Chongqing)" ],
    "华东地区 (East China)": [ "杭州 (Hangzhou)", "南京 (Nanjing)", "福州 (Fuzhou)", "济南 (Jinan)" ],
    "华南地区 (South China)": [ "广州 (Guangzhou)", "深圳 (Shenzhen)", "海口 (Haikou)" ],
    "日本地区 (Japan Region)": [ "东京 (Tokyo)", "大阪 (Osaka)", "京都 (Kyoto)", "札幌 (Sapporo)", "福冈 (Fukuoka)" ],
    "华北/西北/东北地区": [ "西安 (Xi'an)", "兰州 (Lanzhou)", "乌鲁木齐 (Ürümqi)", "沈阳 (Shenyang)", "哈尔滨 (Harbin)" ],
};

// 默认初始数据
const INITIAL_CITY = "上海 (Shanghai)";

// --- 核心工具函数 (Utility Functions) ---

/**
 * 将 OpenWeatherMap 的 weather main 字段映射为应用的简化类型
 */
const mapWeatherType = (main) => {
    main = main.toLowerCase();
    if (main.includes('clear') || main.includes('sun')) return 'clear';
    // 将 Clouds, Haze, Fog, Mist 都视为 'cloudy' 主题
    if (main.includes('clouds') || main.includes('haze') || main.includes('mist') || main.includes('fog')) return 'cloudy';
    return 'cloudy'; 
};

/**
 * 将 UNIX 时间戳转换为本地时间字符串 (注意：OpenWeatherMap的sys时间戳是UTC)
 * 这里使用 UTC 时间戳 + 时区偏移量来计算正确的本地时间。
 */
const formatTimestamp = (timestamp, timezoneOffset) => {
    // timestamp: UTC时间戳 (秒), timezoneOffset: 城市相对于UTC的秒数偏移量
    const localDate = new Date((timestamp + timezoneOffset) * 1000);
    
    // 格式化为 HH:mm，强制使用 UTC/GMT，因为我们已经通过 offset 调整了时间
    return localDate.toUTCString().split(' ')[4].substring(0, 5);
};

/**
 * 模拟未来7天预报数据
 */
const generateMockForecast = (baseTemp, type) => {
    return Array(7).fill().map((_, i) => ({
        day: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"][(new Date().getDay() + i) % 7],
        temp: Number(baseTemp) + Math.floor(Math.random() * 5 - 2), 
        type: Math.random() > 0.7 ? (type === 'clear' ? 'cloudy' : 'clear') : type,
    }));
};

/**
 * 根据城市生成高保真模拟数据 (当 API Key 缺失时使用)
 */
const generateMockWeather = (fullCityName) => {
    const cityName = fullCityName.split(' ')[0];
    let baseTemp, type, desc;

    if (cityName.includes('哈尔滨') || cityName.includes('札幌')) {
        baseTemp = Math.floor(Math.random() * (22 - 18) + 18);
        type = 'cloudy';
        desc = "阴天多云，洛琪希建议带伞。";
    } else if (cityName.includes('广州') || cityName.includes('海口') || cityName.includes('东京')) {
        baseTemp = Math.floor(Math.random() * (32 - 28) + 28);
        type = 'clear';
        desc = "晴空万里，魔法值充满！";
    } else { 
        baseTemp = Math.floor(Math.random() * (29 - 25) + 25);
        type = 'clear';
        desc = "主要晴朗，旅途顺利。";
    }

    const max = Number(baseTemp) + Math.floor(Math.random() * 3 + 1);
    const min = Number(baseTemp) - Math.floor(Math.random() * 3 + 1);
    const isDaytime = new Date().getHours() >= 6 && new Date().getHours() < 18;

    return {
        city: cityName,
        temp: String(baseTemp),
        max: String(max),
        min: String(min),
        desc: desc,
        humidity: Math.floor(Math.random() * (70 - 40) + 40),
        wind: (Math.random() * 4 + 1).toFixed(1),
        pressure: Math.floor(Math.random() * (1020 - 1000) + 1000),
        apparentTemp: String(baseTemp - 1),
        weatherType: type,
        isDaytime: isDaytime,
        // 模拟时间使用当前本地时间
        updateTime: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }),
        sunrise: "06:15",
        sunset: "17:45",
        forecast: generateMockForecast(baseTemp, type)
    };
};

// --- API Fetching (API 数据获取) ---

/**
 * 尝试从 OpenWeatherMap 获取数据，失败则回退到模拟数据
 */
const fetchWeatherData = async (fullCityName, apiKey) => {
    const cityNameEnglish = fullCityName.split('(')[1]?.replace(')', '')?.trim() || fullCityName.split(' ')[0];
    
    // 如果没有 API Key，直接返回模拟数据
    if (!apiKey) {
        return generateMockWeather(fullCityName);
    }

    const url = `${API_BASE_URL}?q=${cityNameEnglish}&units=metric&lang=zh_cn&appid=${apiKey}`;
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`API 返回错误: ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        
        // 映射 OpenWeatherMap 响应到应用内部结构
        const currentTimestamp = Math.floor(Date.now() / 1000);
        const sunriseTime = data.sys.sunrise;
        const sunsetTime = data.sys.sunset;
        
        const isDaytime = currentTimestamp > sunriseTime && currentTimestamp < sunsetTime;
        const mainWeatherType = mapWeatherType(data.weather[0].main);

        return {
            city: data.name,
            temp: data.main.temp.toFixed(0),
            max: data.main.temp_max.toFixed(0),
            min: data.main.temp_min.toFixed(0),
            desc: data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1), // 首字母大写
            humidity: data.main.humidity,
            wind: data.wind.speed.toFixed(1),
            pressure: data.main.pressure,
            apparentTemp: data.main.feels_like.toFixed(0),
            weatherType: mainWeatherType,
            isDaytime: isDaytime,
            // 实时API数据通常不需要更新时间，但我们保留格式，使用当前本地时间
            updateTime: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }),
            sunrise: formatTimestamp(data.sys.sunrise, data.timezone),
            sunset: formatTimestamp(data.sys.sunset, data.timezone),
            // 真实 API 通常只提供当天预报，这里仍使用模拟预报以保持界面完整
            forecast: generateMockForecast(data.main.temp.toFixed(0), mainWeatherType)
        };

    } catch (error) {
        console.error("无法获取实时天气数据，回退到模拟数据:", error);
        throw new Error("实时数据获取失败，已切换到模拟模式。");
    }
};


const getWeatherIcon = (type) => {
  switch (type) {
    case 'clear': return Sun;
    case 'cloudy': return Cloud;
    default: return Zap; 
  }
};

const getThemeClasses = (type, isDaytime) => {
    const theme = WEATHER_THEMES[type] || WEATHER_THEMES.cloudy;
    const primaryClass = `${theme['primary-container']} ${theme['dark-primary-container']}`;
    const onPrimaryClass = `${theme['on-primary-container']} ${theme['dark-on-primary-container']}`;
    const iconClass = `${theme['icon-color']} ${theme['dark-icon-color']}`;
    const progressClass = `${theme['progress-color']} ${theme['dark-progress-color']}`;
    
    const mode = isDaytime ? 'day' : 'night';
    const quote = (ROXY_QUOTES[type] || ROXY_QUOTES.cloudy)[mode];

    return { primaryClass, onPrimaryClass, iconClass, progressClass, quote };
};

// --- 加载骨架屏组件 (Loading Skeleton Component) ---

const LoadingSkeleton = () => (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
        {/* Primary Card Skeleton */}
        <div className="p-8 rounded-[2.5rem] shadow-xl bg-gray-200 dark:bg-gray-800 md:col-span-2 h-72">
            <div className="h-8 bg-gray-300 dark:bg-gray-700 w-3/4 mb-4 rounded-full"></div>
            <div className="h-16 bg-gray-300 dark:bg-gray-700 w-1/3 mb-8 rounded-full"></div>
            <div className="h-6 bg-gray-300 dark:bg-gray-700 w-1/2 rounded-full"></div>
        </div>
        
        {/* Forecast Card Skeleton */}
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 h-72">
            <div className="h-4 bg-gray-300 dark:bg-gray-700 w-1/2 mb-6 rounded-full"></div>
            <div className="space-y-4">
                {[...Array(5)].map((_, i) => (
                    <div key={i} className="flex justify-between items-center">
                        <div className="h-4 bg-gray-300 dark:bg-gray-700 w-1/4 rounded-full"></div>
                        <div className="h-4 bg-gray-300 dark:bg-gray-700 w-1/4 rounded-full"></div>
                    </div>
                ))}
            </div>
        </div>

        {/* Other Cards Skeleton */}
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 h-40"></div>
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 h-40"></div>
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 h-40"></div>
    </div>
);

// --- 城市折叠菜单组件 (Location Collapsible Menu Component) ---

const LocationMenu = ({ onSelect, onClose, currentCity }) => {
    const [openProvince, setOpenProvince] = useState("日本地区 (Japan Region)"); // 默认展开日本

    const toggleProvince = (provinceName) => {
        setOpenProvince(openProvince === provinceName ? null : provinceName);
    };

    return (
        <div className="h-full overflow-y-auto p-6">
            <div className="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white dark:bg-gray-900 z-10">
                <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-100">选择城市</h2>
                <button 
                    onClick={onClose} 
                    className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"
                    aria-label="关闭菜单"
                >
                    <X className="w-6 h-6 text-gray-600 dark:text-gray-300" />
                </button>
            </div>
            
            <div className="space-y-4">
                {Object.entries(CITIES_DATA).map(([province, cities]) => (
                    <div key={province} className="bg-gray-50 dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden transition-all duration-300">
                        {/* 1. 折叠标题 (MD3 Primary Container Style) */}
                        <button 
                            onClick={() => toggleProvince(province)}
                            className="w-full flex justify-between items-center p-4 bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 font-semibold hover:bg-blue-200 dark:hover:bg-blue-800/60 transition"
                        >
                            <span>{province}</span>
                            {openProvince === province ? (
                                <ChevronUp className="w-5 h-5 transition-transform duration-300" />
                            ) : (
                                <ChevronDown className="w-5 h-5 transition-transform duration-300" />
                            )}
                        </button>

                        {/* 2. 可折叠内容 (Cities) */}
                        {openProvince === province && (
                            <div className="p-2 pt-1">
                                {cities.map((city) => (
                                    <button
                                        key={city}
                                        onClick={() => onSelect(city)}
                                        className={`w-full text-left py-3 px-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 transition duration-150 text-base ${city === currentCity ? 'bg-blue-50 dark:bg-gray-700 font-bold' : ''}`}
                                    >
                                        {city}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
};


// --- MD3 卡片组件 (MD3 Card Components) ---

/**
 * 主天气卡片 (Primary Weather Card)
 */
const PrimaryWeatherCard = ({ data, theme, currentCity, localTime }) => {
    const WeatherIcon = getWeatherIcon(data.weatherType);
    const { primaryClass, onPrimaryClass, iconClass } = theme;

    return (
        <div className={`p-6 md:p-8 rounded-[2.5rem] shadow-xl transition duration-500 ${primaryClass} ${onPrimaryClass} md:col-span-2 flex flex-col justify-between`}>
            
            <div className="flex justify-between items-start mb-6">
                <div className='flex flex-col'>
                    <h1 className="text-4xl font-extrabold tracking-tight">
                        {currentCity.split(' ')[0]}
                    </h1>
                    <p className="text-sm opacity-80 mt-1 flex items-center space-x-2">
                        <Clock className="w-4 h-4" />
                        <span>{localTime}</span>
                        <span className='font-bold opacity-60 ml-2'>
                            {OPEN_WEATHER_API_KEY ? '(实时)' : '(模拟)'}
                        </span>
                    </p>
                </div>
                <div className="w-20 h-20 md:w-28 md:h-28 flex-shrink-0">
                    <WeatherIcon className={`w-full h-full ${iconClass}`} strokeWidth={1.5} />
                </div>
            </div>

            <div className="flex flex-col">
                 <div className="flex items-start">
                    <span className="text-8xl md:text-9xl font-black tracking-tighter">
                        {data.temp}
                    </span>
                    <span className="text-4xl font-extrabold mt-4">°C</span>
                </div>

                <div className="mt-4 ml-1">
                    <p className="text-3xl font-bold">{data.desc}</p>
                    <div className="flex items-center space-x-4 mt-2 text-xl font-medium opacity-80">
                        <span>最高 {data.max}°</span>
                        <span className='opacity-50'>|</span>
                        <span>最低 {data.min}°</span>
                    </div>
                </div>
            </div>
        </div>
    );
};

/**
 * 日出日落进度条卡片 (SunPathProgressCard)
 */
const SunPathProgressCard = ({ data, theme, localTime }) => {
    const { progressClass } = theme;

    const timeToMinutes = (time) => {
        const parts = time.split(':');
        return Number(parts[0] || 0) * 60 + Number(parts[1] || 0);
    };

    const sunriseMinutes = timeToMinutes(data.sunrise);
    const sunsetMinutes = timeToMinutes(data.sunset);
    const currentMinutes = timeToMinutes(localTime);

    const totalDaylight = sunsetMinutes - sunriseMinutes;
    let elapsedDaylight = currentMinutes - sunriseMinutes;

    // 处理时间循环：如果当前时间在日落之后，则显示 100%
    if (elapsedDaylight < 0) elapsedDaylight = 0;
    if (elapsedDaylight > totalDaylight) elapsedDaylight = totalDaylight;
    
    // 避免除以零
    let progressPercent = 0;
    if (totalDaylight > 0) {
        progressPercent = (elapsedDaylight / totalDaylight) * 100;
    } else {
        // 如果日照时长为零（例如极昼极夜模拟），给一个默认值
        progressPercent = 50;
    }


    const isDay = currentMinutes > sunriseMinutes && currentMinutes < sunsetMinutes;
    const ProgressIcon = isDay ? Sun : Moon;

    const radius = 50;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (progressPercent / 100) * circumference;

    return (
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 transition duration-500">
            <h3 className="text-base font-semibold mb-6 text-gray-600 dark:text-gray-400">日照时长进度</h3>
            
            <div className="flex flex-col items-center">
                <div className="relative w-36 h-36">
                    <svg className="w-full h-full transform -rotate-90" viewBox="0 0 120 120">
                        <circle
                            cx="60" cy="60" r={radius} fill="none" stroke="currentColor" strokeWidth="10"
                            className="text-gray-200 dark:text-gray-700"
                        />
                        <circle
                            cx="60" cy="60" r={radius} fill="none" stroke="currentColor" strokeWidth="10"
                            strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round"
                            className={`transition-all duration-1000 ${progressClass}`}
                        />
                    </svg>

                    <div className={`absolute inset-0 flex items-center justify-center ${progressClass}`}>
                        <ProgressIcon className="w-12 h-12 animate-pulse" />
                    </div>
                </div>

                <p className={`text-4xl font-extrabold mt-4 ${progressClass}`}>
                    {Math.round(progressPercent)}%
                </p>
                <p className="text-sm text-gray-500 dark:text-gray-400">日光已持续</p>

                <div className="flex justify-between w-full mt-6 text-gray-700 dark:text-gray-300">
                    <div className="flex flex-col items-start">
                        <Sunrise className="w-5 h-5 mb-1 text-orange-400" />
                        <span className="text-xl font-bold">{data.sunrise}</span>
                        <span className="text-xs opacity-70">日出</span>
                    </div>
                    <div className="flex flex-col items-end">
                        <Sunset className="w-5 h-5 mb-1 text-red-500" />
                        <span className="text-xl font-bold">{data.sunset}</span>
                        <span className="text-xs opacity-70">日落</span>
                    </div>
                </div>
            </div>
        </div>
    );
};

/**
 * 洛琪希箴言卡片 (Roxy Quote Card)
 */
const RoxyCard = ({ data, quote }) => {
    const quoteBorderColor = data.weatherType === 'clear' ? 'border-amber-400 dark:border-amber-600' : 'border-slate-400 dark:border-slate-600';

    return (
        <div className="p-6 rounded-[2rem] shadow-md bg-violet-50 dark:bg-violet-950 transition duration-500">
            <div className="flex items-start space-x-4 mb-4">
                <div className="flex-shrink-0 w-12 h-12 rounded-full bg-violet-300 dark:bg-violet-700 p-2 flex items-center justify-center">
                    <Zap className="w-6 h-6 text-violet-800 dark:text-violet-300" />
                </div>
                <h3 className="text-xl font-bold pt-1 text-gray-900 dark:text-gray-100">洛琪希的箴言</h3>
            </div>
            
            <p className={`text-lg italic pl-4 border-l-4 ${quoteBorderColor} text-gray-700 dark:text-gray-300 transition-all duration-500`}>
                “{quote}”
            </p>
        </div>
    );
};

/**
 * 详细指数卡片 (Detail Metrics Card)
 */
const DetailMetricsCard = ({ data }) => {
    const DetailItem = ({ icon: Icon, label, value, color }) => (
        <div>
            <div className="flex items-center mb-1 text-gray-500 dark:text-gray-400">
                 <Icon className={`w-5 h-5 mr-2 ${color}`} />
                 <p className="text-sm">{label}</p>
            </div>
            <p className="text-2xl font-bold text-gray-800 dark:text-gray-200">{value}</p>
        </div>
    );

    return (
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 transition duration-500">
            <h3 className="text-base font-semibold mb-6 text-gray-600 dark:text-gray-400">详细指数</h3>
            <div className="grid grid-cols-2 gap-y-6 gap-x-4">
                <DetailItem icon={Droplet} label="湿度" value={`${data.humidity}%`} color="text-blue-500" />
                <DetailItem icon={Wind} label="风速" value={`${data.wind} m/s`} color="text-green-500" />
                <DetailItem icon={Gauge} label="气压" value={`${data.pressure} hPa`} color="text-indigo-500" />
                <DetailItem icon={Zap} label="体感" value={`${data.apparentTemp}°C`} color="text-red-400" />
            </div>
        </div>
    );
};

/**
 * 未来七天预报卡片 (7-Day Forecast Card)
 */
const ForecastCard = ({ data }) => {
    return (
        <div className="p-6 rounded-[2rem] shadow-md bg-white dark:bg-gray-800 transition duration-500">
            <h3 className="text-base font-semibold mb-4 text-gray-600 dark:text-gray-400">未来几天 (模拟预报)</h3>
            <div className="flex flex-col space-y-3">
                {data.forecast.map((item, index) => {
                    const ForecastIcon = getWeatherIcon(item.type);
                    const iconColor = item.type === 'clear' ? 'text-amber-500' : 'text-slate-600';

                    return (
                        <div key={index} className="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                            <p className="text-base font-medium text-gray-700 dark:text-gray-300 w-1/4">{item.day}</p>
                            <div className="w-1/4 flex justify-center">
                                <ForecastIcon className={`w-6 h-6 ${iconColor}`} />
                            </div>
                            <p className="text-base font-bold text-gray-900 dark:text-gray-100 w-1/4 text-right">{item.temp}°</p>
                            <p className="text-sm text-gray-500 dark:text-gray-400 w-1/4 text-right">{item.temp - 5}°</p>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

/**
 * 主应用组件
 */
const App = () => {
    // 1. 状态初始化
    const [currentCity, setCurrentCity] = useState(INITIAL_CITY); 
    const [weatherData, setWeatherData] = useState(generateMockWeather(INITIAL_CITY));
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false); 
    const [error, setError] = useState(null); 
    const [localTime, setLocalTime] = useState(new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }));

    // 实时时钟更新
    useEffect(() => {
        const timer = setInterval(() => {
            setLocalTime(new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }));
        }, 1000);
        return () => clearInterval(timer);
    }, []);

    // 城市选择处理函数 (包含 API 调用/模拟数据加载和延迟)
    const handleSelectLocation = useCallback(async (city, showLoading = true) => {
        setError(null);
        setCurrentCity(city);
        setIsMenuOpen(false);

        if (showLoading) setIsLoading(true);

        try {
            const data = await fetchWeatherData(city, OPEN_WEATHER_API_KEY);
            // 模拟 API 调用的延迟
            await new Promise(resolve => setTimeout(resolve, showLoading ? 800 : 0));
            
            setWeatherData(data);

            if (!OPEN_WEATHER_API_KEY) {
                 setError("⚠️ API Key 未设置。当前显示的是基于城市特征的模拟数据，并非实时数据。");
            } else {
                setError(null);
            }

        } catch (err) {
            setError(err.message || "数据加载失败，已切换到模拟模式。");
            setWeatherData(generateMockWeather(city)); // 错误时也使用模拟数据
        } finally {
            setIsLoading(false);
        }
    }, []);

    // 初始加载效果，确保首次进入应用时有数据
    useEffect(() => {
        handleSelectLocation(INITIAL_CITY, false);
    }, [handleSelectLocation]); 

    // 切换黑暗模式
    const toggleDarkMode = () => {
        setIsDarkMode(!isDarkMode);
        document.documentElement.classList.toggle('dark');
    };

    // 计算主题类和箴言 (依赖 weatherData)
    const themeClasses = useMemo(() => {
        return getThemeClasses(weatherData.weatherType, weatherData.isDaytime);
    }, [weatherData.weatherType, weatherData.isDaytime]);

    return (
        <div className={`min-h-screen p-4 md:p-8 font-['Inter'] ${isDarkMode ? 'bg-gray-900' : 'bg-gray-100'} transition-colors duration-500`}>
            <div className="max-w-6xl mx-auto">
                {/* 顶部控制栏 - 城市选择和模式切换 */}
                <div className="flex justify-between items-center mb-6 p-4 bg-white dark:bg-gray-800 rounded-full shadow-lg">
                    <button 
                        onClick={() => setIsMenuOpen(true)}
                        className="flex items-center space-x-2 text-gray-700 dark:text-gray-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"
                    >
                        <MapPin className="w-5 h-5" />
                        <span className="font-semibold text-lg">{currentCity}</span>
                        <ChevronDown className="w-4 h-4 ml-1" />
                    </button>
                    
                    <button 
                        onClick={toggleDarkMode}
                        className="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 shadow-inner hover:shadow-md transition duration-300"
                        aria-label="Toggle Dark Mode"
                    >
                        {isDarkMode ? <Sun className="w-6 h-6" /> : <Moon className="w-6 h-6" />}
                    </button>
                </div>

                {/* API 错误/警告信息 */}
                {error && (
                    <div className="bg-red-100 border border-red-400 text-red-700 dark:bg-red-900 dark:border-red-600 dark:text-red-200 p-4 rounded-xl mb-6 font-medium text-center">
                        {error}
                    </div>
                )}


                {/* 主内容区域 */}
                {isLoading ? (
                    <LoadingSkeleton />
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

                        <PrimaryWeatherCard data={weatherData} theme={themeClasses} currentCity={currentCity} localTime={localTime} />
                        <div className="md:col-span-1 row-start-2 md:row-start-1">
                            <ForecastCard data={weatherData} />
                        </div>
                        <RoxyCard data={weatherData} quote={themeClasses.quote} />
                        <DetailMetricsCard data={weatherData} />
                        <SunPathProgressCard data={weatherData} theme={themeClasses} localTime={localTime} />
                    </div>
                )}
            </div>

            {/* 城市选择侧边抽屉/浮层 */}
            {isMenuOpen && (
                <div 
                    className="fixed inset-0 z-50 transition-opacity duration-300"
                    style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }} // 遮罩
                >
                    <div 
                        className="fixed top-0 left-0 w-full md:w-96 h-full bg-white dark:bg-gray-900 shadow-2xl overflow-hidden transition-transform duration-300"
                    >
                        <LocationMenu 
                            onSelect={handleSelectLocation} 
                            onClose={() => setIsMenuOpen(false)} 
                            currentCity={currentCity}
                        />
                    </div>
                    {/* 点击遮罩关闭 */}
                    <div className="absolute inset-0" onClick={() => setIsMenuOpen(false)}></div>
                </div>
            )}
        </div>
    );
};

export default App;
